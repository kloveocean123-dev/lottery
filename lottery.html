<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<title>🎯 轉盤抽獎｜雙資料層（觀眾顯示 vs 真實管理）</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  body { background:#f7f7fb; }
  .wheel-wrap{ position:relative; width:560px; max-width:92vw; margin:24px auto; }
  #wheel{ width:100%; height:auto; background:#fff; border-radius:50%; box-shadow:0 10px 30px rgba(0,0,0,.08); }
  .pointer{ position:absolute; left:50%; top:-18px; transform:translateX(-50%);
    width:0; height:0; border-left:16px solid transparent; border-right:16px solid transparent; border-bottom:28px solid #e74c3c;
    filter:drop-shadow(0 2px 4px rgba(0,0,0,.2)); }
  .floating-admin-btn{
    position: fixed; top: 12px; right: 12px; z-index: 1046;
    border-radius: 999px; box-shadow: 0 6px 18px rgba(0,0,0,.12);
  }
  .mini{ width:100px; }
  .qty{ width:86px; }
  .table > :not(caption) > * > * { vertical-align: middle; }
  .pill { display:inline-block; padding:.25rem .5rem; border-radius:999px; background:#f2f2f7; font-size:.8rem; }
</style>
</head>
<body>

 <!-- 觀眾畫面（預設只看到這個） -->
 <div class="container py-4">
   <h2 class="mb-1">🎯 轉盤抽獎</h2>
   <p class="text-muted mb-4">
     <!-- 轉盤切片依「<span class="pill">籤數</span>」呈現；真實結果由管理員決定。 -->
   </p>
   
   <!-- 用戶顯示設定（與輪盤同頁） -->
   <div class="row g-4 mb-4">
     <div class="col-md-6">
       <div class="card">
         <div class="card-header">新增帳號（顯示用）</div>
         <div class="card-body">
           <form id="addDisplayForm" class="row g-2">
             <div class="col-12">
               <label class="form-label">名稱</label>
               <input id="dName" class="form-control" required placeholder="例如：小明">
             </div>
             <div class="col-6">
               <label class="form-label">籤數</label>
               <input id="dTickets" type="number" min="0" step="1" value="1" class="form-control" required>
             </div>
             <div class="col-6">
               <label class="form-label">顏色</label>
               <input id="dColor" type="color" class="form-control form-control-color" value="#66cc99">
             </div>
             <div class="col-12 d-grid">
               <button class="btn btn-primary">新增</button>
             </div>
           </form>
         </div>
       </div>
     </div>
     
     <div class="col-md-6">
       <div class="card">
         <div class="card-header d-flex align-items-center">
           <span>帳號列表</span>
           <span class="ms-auto small text-muted">總籤數：<span id="sumDisplayTickets">0</span></span>
         </div>
         <div class="card-body p-0">
           <div class="table-responsive">
             <table class="table table-striped table-hover mb-0">
               <thead class="table-light">
                 <tr><th>#</th><th>名稱</th><th class="text-center">籤數</th><th class="text-center">快速調整</th><th class="text-center">刪除</th></tr>
               </thead>
               <tbody id="displayTbody"></tbody>
             </table>
           </div>
         </div>
         <div class="card-footer d-flex gap-2">
           <button id="normalizeDisplay" class="btn btn-outline-secondary btn-sm">籤數正規化</button>
           <button id="loadDemoDisplay" class="btn btn-outline-primary btn-sm">載入示例</button>
         </div>
       </div>
     </div>
   </div>
   
   <!-- 輪盤區域 -->
   <div class="wheel-wrap">
     <div class="pointer"></div>
     <canvas id="wheel" width="560" height="560"></canvas>
   </div>
   
   <!-- 抽獎控制（用戶可見） -->
   <div class="text-center mt-4">
     <button id="spinBtn" class="btn btn-success btn-lg px-5">🎯 開始抽獎</button>
     <div id="tip" class="text-muted mt-3">等待抽獎中…</div>
   </div>
 </div>

<!-- 右上角 Admin -->
<button class="btn btn-dark floating-admin-btn" data-bs-toggle="offcanvas" data-bs-target="#admin" aria-controls="admin">⚙️ Admin</button>

<!-- Offcanvas 控制台 -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="admin" aria-labelledby="adminLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="adminLabel">⚙️ 控制台</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

     <div class="offcanvas-body d-flex flex-column gap-3">
     <ul class="nav nav-tabs" role="tablist">
       <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-admin" type="button" role="tab">管理設定</button></li>
       <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-winners" type="button" role="tab">中獎紀錄</button></li>
     </ul>

     <div class="tab-content flex-grow-1">

       <!-- 管理設定：只設定實際中獎者 -->
       <div class="tab-pane fade show active" id="tab-admin" role="tabpanel">
         <div class="small text-muted mb-2">這裡的設定 <strong>會決定真實結果</strong>。觀眾不會看到。</div>
         
         <div class="card">
           <div class="card-header">設定實際中獎者</div>
           <div class="card-body">
             <div class="d-flex align-items-center gap-2 mb-3">
               <label class="form-label mb-0">內定下一轉：</label>
               <select id="rigSelect" class="form-select" style="width:220px">
                 <option value="">（不內定）</option>
               </select>
               <button id="clearRig" class="btn btn-outline-danger btn-sm">清除內定</button>
             </div>
             <div class="small text-muted">
               • 選擇內定後，下次抽獎必定是該人員<br>
               • 內定只生效一次，用完自動清除<br>
               • 不設定內定則隨機抽獎
             </div>
           </div>
         </div>

         <div class="card">
           <div class="card-header">帳號管理</div>
           <div class="card-body">
             <div class="table-responsive">
               <table class="table table-striped table-hover mb-0">
                 <thead class="table-light">
                   <tr><th>#</th><th>名稱</th><th class="text-center">內定下一轉</th><th class="text-center">刪除</th></tr>
                 </thead>
                 <tbody id="adminTbody"></tbody>
               </table>
             </div>
           </div>
         </div>

         <div id="msg" class="mt-3"></div>
       </div>

       <!-- 中獎紀錄 -->
       <div class="tab-pane fade" id="tab-winners" role="tabpanel">
         <div class="d-flex justify-content-between align-items-center mb-2">
           <h6 class="mb-0">中獎紀錄</h6>
           <div class="d-flex gap-2">
             <button id="exportBtn" class="btn btn-outline-primary btn-sm">匯出 CSV</button>
             <button id="clearWinBtn" class="btn btn-outline-danger btn-sm">清空紀錄</button>
           </div>
         </div>
         <div class="table-responsive">
           <table class="table table-striped table-hover align-middle">
             <thead class="table-light">
               <tr><th>#</th><th>姓名</th><th>時間（本地）</th><th>ISO</th></tr>
             </thead>
             <tbody id="winnersBody"></tbody>
           </table>
         </div>
       </div>

     </div>
   </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(() => {
     // ========= 資料模型 =========
   // 簡化為單一名單：每個帳號有 id/name/color/tickets
   // 管理員可以設定內定中獎者
   let accounts = []; // {id,name,color,tickets}
   let rigNextId = null;        // 內定下一轉
   let spinning = false;
   let currentRotation = 0;     // deg

  // ========= DOM（展示）=========
  const wheel = document.getElementById('wheel');
  const wctx  = wheel.getContext('2d');
  const tip   = document.getElementById('tip');

     // ========= DOM（用戶界面）=========
   const displayTbody = document.getElementById('displayTbody');
   const sumDisplayTicketsEl = document.getElementById('sumDisplayTickets');
   const addDisplayForm = document.getElementById('addDisplayForm');
   const dName = document.getElementById('dName');
   const dTickets = document.getElementById('dTickets');
   const dColor = document.getElementById('dColor');

   // ========= DOM（管理界面）=========
   const adminTbody = document.getElementById('adminTbody');
   const rigSelect = document.getElementById('rigSelect');
   const msg = document.getElementById('msg');

  // ========= DOM（紀錄）=========
  const winnersBody = document.getElementById('winnersBody');

  // ========= 工具 =========
  const uid = (()=>{ let n=1; return ()=>n++; })();
  const sum = (arr, fn) => arr.reduce((a,b)=>a+fn(b),0);
  const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
  const showToast = (html, type='light') => { msg.innerHTML = `<div class="alert alert-${type} mb-0">${html}</div>`; };

  // 隨機色（只在無自選色時使用）
  const randColor = (i=0)=>`hsl(${(i*137.508)%360} 80% 60%)`;

     // ========= 永續化 =========
   function persist(){
     localStorage.setItem('lottery_simple_accounts', JSON.stringify(accounts));
     localStorage.setItem('lottery_simple_rig', JSON.stringify(rigNextId));
   }
   function loadPersist(){
     try{
       const a = JSON.parse(localStorage.getItem('lottery_simple_accounts')||'[]');
       if (Array.isArray(a)) accounts = a;
       const r = JSON.parse(localStorage.getItem('lottery_simple_rig')||'null');
       rigNextId = r;
     }catch{}
   }

     // ========= 初始化示例 =========
   function loadDemo(){
     accounts = [
       { id: uid(), name:'小明', color:randColor(0), tickets:5 },
       { id: uid(), name:'小美', color:randColor(1), tickets:2 },
       { id: uid(), name:'阿丹', color:randColor(2), tickets:3 },
       { id: uid(), name:'旺財', color:randColor(3), tickets:1 },
     ];
     rigNextId = null;
     currentRotation = 0;
     updateAll();
   }

     // ========= 轉盤繪圖 =========
   function drawWheel(){
     const list = accounts.filter(a=>(a.tickets|0) > 0);
     const W=wheel.width,H=wheel.height,cx=W/2,cy=H/2,r=Math.min(cx,cy)-8;
     wctx.clearRect(0,0,W,H);

     const totalTickets = Math.max(sum(list, a=>a.tickets|0), 0.000001);
     let start = (currentRotation % 360) * Math.PI/180;

     list.forEach(a=>{
       const frac = (a.tickets|0)/totalTickets;
       const sweep = frac * Math.PI*2;

       wctx.beginPath();
       wctx.moveTo(cx,cy);
       wctx.arc(cx,cy,r,start,start+sweep);
       wctx.closePath();
       wctx.fillStyle = a.color || '#ccc';
       wctx.fill();
       wctx.strokeStyle = '#fff'; wctx.lineWidth=2; wctx.stroke();

       const mid=start+sweep/2;
       const tx=cx+Math.cos(mid)*r*0.62, ty=cy+Math.sin(mid)*r*0.62;
       wctx.save();
       wctx.translate(tx,ty); wctx.rotate(mid);
       wctx.textAlign='center'; wctx.textBaseline='middle';
       wctx.fillStyle='#222';
       wctx.font='bold 16px system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Arial';
       wrapText(wctx, a.name, 0,0, r*0.52, 18);
       wctx.restore();

       start += sweep;
     });

     // 中心圓
     wctx.beginPath(); wctx.arc(cx,cy,r*0.1,0,Math.PI*2);
     wctx.fillStyle='#fff'; wctx.fill();
     wctx.strokeStyle='#ddd'; wctx.stroke();
   }
  function wrapText(ctx, text, x,y, maxW, lh){
    const chars = (text||'').split(''); let line='', yoff=0;
    for(let i=0;i<chars.length;i++){
      const test=line+chars[i];
      if(ctx.measureText(test).width>maxW && i>0){ ctx.fillText(line,x,y+yoff); line=chars[i]; yoff+=lh; }
      else line=test;
    }
    ctx.fillText(line,x,y+yoff);
  }

     // ========= 用戶界面表格 =========
   function renderDisplayTable(){
     const list = accounts.filter(a=>(a.tickets|0)>0);
     displayTbody.innerHTML='';
     list.forEach((a,idx)=>{
       const tr = document.createElement('tr');
       tr.innerHTML = `
         <td>${idx+1}</td>
         <td><input class="form-control form-control-sm" value="${a.name}"></td>
         <td class="text-center"><input class="form-control form-control-sm qty" type="number" min="0" step="1" value="${a.tickets|0}"></td>
         <td class="text-center">
           <div class="btn-group btn-group-sm">
             <button class="btn btn-outline-secondary minus">−1</button>
             <button class="btn btn-outline-secondary plus">+1</button>
           </div>
         </td>
         <td class="text-center">
           <button class="btn btn-sm btn-outline-danger del">刪除</button>
         </td>
       `;
       // 名稱
       tr.children[1].querySelector('input').addEventListener('input', ev=>{
         a.name = ev.target.value; rebuildRigSelect(); renderAdminTable(); drawWheel(); persist();
       });
       // 籤數
       const qty = tr.children[2].querySelector('.qty');
       qty.addEventListener('input', ev=>{
         a.tickets = Math.max(0, Math.floor(+ev.target.value||0));
         updateDisplaySum(); drawWheel(); persist();
       });
       tr.querySelector('.minus').addEventListener('click', ()=>{
         a.tickets = Math.max(0, (a.tickets|0) - 1); qty.value=a.tickets; updateDisplaySum(); drawWheel(); persist();
       });
       tr.querySelector('.plus').addEventListener('click', ()=>{
         a.tickets = (a.tickets|0) + 1; qty.value=a.tickets; updateDisplaySum(); drawWheel(); persist();
       });
       // 刪除
       tr.querySelector('.del').addEventListener('click', ()=>{
         if (rigNextId === a.id) rigNextId = null;
         if (rigSelect.value == a.id) rigSelect.value = '';
         accounts = accounts.filter(x => x.id !== a.id);
         updateAll();
       });
       displayTbody.appendChild(tr);
     });
   }
   function updateDisplaySum(){
     const list = accounts.filter(a=>(a.tickets|0)>0);
     sumDisplayTicketsEl.textContent = sum(list, a=>a.tickets|0);
   }

     // ========= 管理表格 =========
   function renderAdminTable(){
     const list = accounts.slice();
     adminTbody.innerHTML='';
     list.forEach((a,idx)=>{
       const tr = document.createElement('tr');
       tr.innerHTML = `
         <td>${idx+1}</td>
         <td><input class="form-control form-control-sm" value="${a.name}"></td>
         <td class="text-center">
           <div class="form-check d-flex justify-content-center">
             <input class="form-check-input rigbox" type="checkbox" ${(rigNextId===a.id || rigSelect.value==a.id)?'checked':''}>
           </div>
         </td>
         <td class="text-center"><button class="btn btn-sm btn-outline-danger del">刪除</button></td>
       `;
       // 名稱同步
       tr.children[1].querySelector('input').addEventListener('input', ev=>{
         a.name = ev.target.value; rebuildRigSelect(); renderDisplayTable(); drawWheel(); persist();
       });
       // 內定（每列）
       tr.children[2].querySelector('.rigbox').addEventListener('change', ev=>{
         if(ev.target.checked){ 
           rigNextId = a.id; 
           rigSelect.value = a.id;
         } else if(rigNextId===a.id || rigSelect.value==a.id){ 
           rigNextId = null; 
           rigSelect.value = '';
         }
         persist(); renderAdminTable(); rebuildRigSelect();
       });
       // 刪除
       tr.children[3].querySelector('.del').addEventListener('click', ()=>{
         if (rigNextId === a.id) rigNextId = null;
         if (rigSelect.value == a.id) rigSelect.value = '';
         accounts = accounts.filter(x => x.id !== a.id);
         updateAll();
       });
       adminTbody.appendChild(tr);
     });
   }
  function rebuildRigSelect(){
    const prev = rigSelect.value || '';
    rigSelect.innerHTML = `<option value="">（不內定）</option>` + accounts.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
    rigSelect.value = prev;
    
    // 同步更新状态显示
    updateStatusDisplay();
  }

     // ========= Winners =========
   function getWinners(){ try{ return JSON.parse(localStorage.getItem('lottery_simple_winners')||'[]'); }catch{ return []; } }
   function setWinners(list){ localStorage.setItem('lottery_simple_winners', JSON.stringify(list)); }
  function addWinner(name){
    const list = getWinners();
    list.push({ name, time: new Date().toISOString() });
    setWinners(list);
    renderWinners();
  }
  function renderWinners(){
    const list=getWinners();
    winnersBody.innerHTML='';
    list.forEach((r,i)=>{
      const dt=new Date(r.time);
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${r.name}</td><td>${dt.toLocaleString()}</td><td>${r.time}</td>`;
      winnersBody.appendChild(tr);
    });
  }

     // ========= 抽獎邏輯 =========
   function pickWinner(){
     // 1) 內定（僅下一轉）
     if (rigSelect.value) {
       const id = Number(rigSelect.value);
       const a = accounts.find(x=>x.id===id);
       rigNextId = null; // 用下拉選單視為一次性
       rigSelect.value = '';
       persist(); rebuildRigSelect(); renderAdminTable();
       return a || null;
     }
     if (rigNextId != null) {
       const a = accounts.find(x=>x.id===rigNextId) || null;
       rigNextId = null; persist(); rebuildRigSelect(); renderAdminTable();
       return a;
     }
     // 2) 隨機抽獎（依籤數）
     const list = accounts.filter(a=>(a.tickets|0)>0);
     if (list.length === 0) return null;
     
     const total = sum(list, a=>a.tickets|0);
     if (total <= 0) return null;
     
     let r = Math.random()*total;
     for (const a of list) {
       r -= (a.tickets|0);
       if (r <= 1e-12) return a;
     }
     return list[list.length-1] || null;
   }

     // 計算讓「中獎者」在轉盤停在指針 12 點方向
   function targetAngleForWinner(winnerId){
     const winner = accounts.find(a=>a.id===winnerId);
     if (!winner) return currentRotation + (360*18) + Math.random()*360;

     // 獲取所有有籤數的帳號
     const list = accounts.filter(a=>(a.tickets|0)>0);
     
     // 如果中獎者不在顯示列表中，創建一個臨時列表包含他
     let tempList = list.slice();
     if (!tempList.find(x=>x.id===winnerId)) {
       // 給予一個極小的籤數，確保他能被指向
       tempList.push({ 
         id: winner.id, 
         name: winner.name, 
         color: winner.color || '#ccc', 
         tickets: 0.00001 
       });
     }

     // 計算總籤數
     const total = tempList.reduce((s,a)=> s + ((a.tickets||0)*1), 0);
     if (total <= 0) return currentRotation + (360*18) + Math.random()*360;

     // 計算每個切片的角度
     let startDeg = (currentRotation % 360 + 360) % 360;
     let acc = 0;

     for (const a of tempList) {
       const sweep = ((a.tickets||0)/total) * 360;
       const segStart = startDeg + acc;
       const mid = segStart + sweep/2;
       
       if (a.id === winnerId) {
         // 計算讓中獎者停在12點方向的角度
         // 12點方向是 -90度（或270度）
         const targetAngle = -90;
         const currentMid = mid * Math.PI / 180;
         const targetRad = targetAngle * Math.PI / 180;
         
         // 計算需要旋轉的角度
         const angleDiff = targetRad - currentMid;
         const rotations = 18; // 多轉幾圈
         const finalAngle = currentRotation + (rotations * 360) + (angleDiff * 180 / Math.PI);
         
         return finalAngle;
       }
       acc += sweep;
     }
     
     return currentRotation + (360*18) + Math.random()*360;
   }

  function animateTo(endDeg, duration=4000){
    const start=currentRotation, delta=endDeg-start;
    const t0=performance.now(); const ease=t=>1-Math.pow(1-t,3);
    const step = now=>{
      const p=clamp((now-t0)/duration,0,1);
      currentRotation = start + delta*ease(p);
      drawWheel();
      if(p<1) requestAnimationFrame(step);
      else currentRotation=endDeg%360;
    };
    requestAnimationFrame(step);
  }

     // ========= 更新 =========
   function updateAll(){
     renderDisplayTable();
     renderAdminTable();
     rebuildRigSelect();
     updateDisplaySum();
     drawWheel();
     persist();
     
     // 更新状态显示
     updateStatusDisplay();
   }
  
  function updateStatusDisplay(){
    if(rigNextId) {
      const riggedPerson = accounts.find(a => a.id === rigNextId);
      if(riggedPerson) {
        // tip.textContent = `🎯 已設定內定下一轉：${riggedPerson.name}，等待抽獎…`;
      } else {
        tip.textContent = '設定已更新，等待抽獎…';
      }
    } else if(rigSelect.value) {
      const riggedPerson = accounts.find(a => a.id === Number(rigSelect.value));
      if(riggedPerson) {
        tip.textContent = `🎯 已設定內定下一轉：${riggedPerson.name}，等待抽獎…`;
      } else {
        tip.textContent = '設定已更新，等待抽獎…';
      }
    } else {
      tip.textContent = '設定已更新，等待抽獎…';
    }
  }

     // ========= 事件繫結 =========
   // 用戶界面：新增
   addDisplayForm.addEventListener('submit', ev=>{
     ev.preventDefault();
     const name = dName.value.trim();
     const tickets = Math.max(0, Math.floor(+dTickets.value||0));
     if (!name) return;
     
     // 同名若已存在就更新，否則建新帳號
     let a = accounts.find(x=>x.name===name);
     if (!a) {
       a = { id: uid(), name, color: dColor.value || randColor(accounts.length), tickets };
       accounts.push(a);
     } else {
       a.tickets = tickets;
       if (!a.color) a.color = dColor.value || randColor(accounts.length);
     }
     dName.value=''; dTickets.value='1';
     updateAll();
   });

   document.getElementById('normalizeDisplay').addEventListener('click', ()=>{
     const list = accounts.filter(a=>(a.tickets|0)>0);
     const s = list.reduce((t,a)=>t+(a.tickets|0),0);
     if (s<=0) return;
     list.forEach(a=> a.tickets = Math.max(0, Math.round(((a.tickets|0)/s)*100)) );
     updateAll();
   });
   document.getElementById('loadDemoDisplay').addEventListener('click', ()=>{ loadDemo(); });

  document.getElementById('clearRig').addEventListener('click', ()=>{
    rigNextId=null; rigSelect.value=''; persist();
    updateStatusDisplay();
    showToast('已清除內定。','light');
  });

  rigSelect.addEventListener('change', ()=>{
    // 更新状态显示
    updateStatusDisplay();
  });

     // 抽獎按鈕
   document.getElementById('spinBtn').addEventListener('click', ()=>{
     if (spinning) return;
     if (!accounts.length){ showToast('尚無帳號。','warning'); return; }

     // 检查是否为内定抽奖
     const wasRigged = rigNextId || rigSelect.value;
     
     const winner = pickWinner();
     if (!winner){ showToast('籤數總和為 0，無法抽獎。','danger'); return; }

     const target = targetAngleForWinner(winner.id);
     spinning = true;
     
     // 显示抽奖信息，如果是内定则特别标注
     if(wasRigged) {
    //    tip.textContent = `🎯 內定抽出「${winner.name}」…`;
     } else {
       tip.textContent = `正在抽出「${winner.name}」…`;
     }
     
     animateTo(target, 4000);
     setTimeout(()=>{
       spinning=false;
    //    tip.textContent = `中獎者：${winner.name}`;
       addWinner(winner.name);
       
       // 显示结果，如果是内定则特别标注
       if(wasRigged) {
        //  showToast(`🎯 內定中獎者：<strong>${winner.name}</strong>（已記錄）`, 'success');
       } else {
        //  showToast(`中獎者：<strong>${winner.name}</strong>（已記錄）`, 'success');
       }
     }, 4100);
   });

  // 紀錄面板
  document.getElementById('clearWinBtn').addEventListener('click', ()=>{
    if (confirm('確定清空所有中獎紀錄？')){ setWinners([]); renderWinners(); }
  });
  document.getElementById('exportBtn').addEventListener('click', ()=>{
    const rows = [['#','name','local_time','iso_time']];
    const list = getWinners();
    list.forEach((r,i)=>{
      const dt=new Date(r.time);
      rows.push([i+1, r.name, dt.toLocaleString(), r.time]);
    });
    const csv = rows.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='winners.csv'; a.click(); URL.revokeObjectURL(url);
  });

  // ========= 啟動 =========
  loadPersist();
  if (!accounts.length) loadDemo(); else updateAll();
  renderWinners();

})();
</script>
</body>
</html>
