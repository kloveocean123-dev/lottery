<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<title>ğŸ¯ è½‰ç›¤æŠ½çï½œé›™è³‡æ–™å±¤ï¼ˆè§€çœ¾é¡¯ç¤º vs çœŸå¯¦ç®¡ç†ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  body { background:#f7f7fb; }
  .wheel-wrap{ position:relative; width:560px; max-width:92vw; margin:24px auto; }
  #wheel{ width:100%; height:auto; background:#fff; border-radius:50%; box-shadow:0 10px 30px rgba(0,0,0,.08); }
  .pointer{ position:absolute; left:50%; top:-18px; transform:translateX(-50%);
    width:0; height:0; border-left:16px solid transparent; border-right:16px solid transparent; border-bottom:28px solid #e74c3c;
    filter:drop-shadow(0 2px 4px rgba(0,0,0,.2)); }
  .floating-admin-btn{
    position: fixed; top: 12px; right: 12px; z-index: 1046;
    border-radius: 999px; box-shadow: 0 6px 18px rgba(0,0,0,.12);
  }
  .mini{ width:100px; }
  .qty{ width:86px; }
  .table > :not(caption) > * > * { vertical-align: middle; }
  .pill { display:inline-block; padding:.25rem .5rem; border-radius:999px; background:#f2f2f7; font-size:.8rem; }
</style>
</head>
<body>

 <!-- è§€çœ¾ç•«é¢ï¼ˆé è¨­åªçœ‹åˆ°é€™å€‹ï¼‰ -->
 <div class="container py-4">
   <h2 class="mb-1">ğŸ¯ è½‰ç›¤æŠ½ç</h2>
   <p class="text-muted mb-4">
     <!-- è½‰ç›¤åˆ‡ç‰‡ä¾ã€Œ<span class="pill">ç±¤æ•¸</span>ã€å‘ˆç¾ï¼›çœŸå¯¦çµæœç”±ç®¡ç†å“¡æ±ºå®šã€‚ -->
   </p>
   
   <!-- ç”¨æˆ¶é¡¯ç¤ºè¨­å®šï¼ˆèˆ‡è¼ªç›¤åŒé ï¼‰ -->
   <div class="row g-4 mb-4">
     <div class="col-md-6">
       <div class="card">
         <div class="card-header">æ–°å¢å¸³è™Ÿï¼ˆé¡¯ç¤ºç”¨ï¼‰</div>
         <div class="card-body">
           <form id="addDisplayForm" class="row g-2">
             <div class="col-12">
               <label class="form-label">åç¨±</label>
               <input id="dName" class="form-control" required placeholder="ä¾‹å¦‚ï¼šå°æ˜">
             </div>
             <div class="col-6">
               <label class="form-label">ç±¤æ•¸</label>
               <input id="dTickets" type="number" min="0" step="1" value="1" class="form-control" required>
             </div>
             <div class="col-6">
               <label class="form-label">é¡è‰²</label>
               <input id="dColor" type="color" class="form-control form-control-color" value="#66cc99">
             </div>
             <div class="col-12 d-grid">
               <button class="btn btn-primary">æ–°å¢</button>
             </div>
           </form>
         </div>
       </div>
     </div>
     
     <div class="col-md-6">
       <div class="card">
         <div class="card-header d-flex align-items-center">
           <span>å¸³è™Ÿåˆ—è¡¨</span>
           <span class="ms-auto small text-muted">ç¸½ç±¤æ•¸ï¼š<span id="sumDisplayTickets">0</span></span>
         </div>
         <div class="card-body p-0">
           <div class="table-responsive">
             <table class="table table-striped table-hover mb-0">
               <thead class="table-light">
                 <tr><th>#</th><th>åç¨±</th><th class="text-center">ç±¤æ•¸</th><th class="text-center">å¿«é€Ÿèª¿æ•´</th><th class="text-center">åˆªé™¤</th></tr>
               </thead>
               <tbody id="displayTbody"></tbody>
             </table>
           </div>
         </div>
         <div class="card-footer d-flex gap-2">
           <button id="normalizeDisplay" class="btn btn-outline-secondary btn-sm">ç±¤æ•¸æ­£è¦åŒ–</button>
           <button id="loadDemoDisplay" class="btn btn-outline-primary btn-sm">è¼‰å…¥ç¤ºä¾‹</button>
         </div>
       </div>
     </div>
   </div>
   
   <!-- è¼ªç›¤å€åŸŸ -->
   <div class="wheel-wrap">
     <div class="pointer"></div>
     <canvas id="wheel" width="560" height="560"></canvas>
   </div>
   
   <!-- æŠ½çæ§åˆ¶ï¼ˆç”¨æˆ¶å¯è¦‹ï¼‰ -->
   <div class="text-center mt-4">
     <button id="spinBtn" class="btn btn-success btn-lg px-5">ğŸ¯ é–‹å§‹æŠ½ç</button>
     <div id="tip" class="text-muted mt-3">ç­‰å¾…æŠ½çä¸­â€¦</div>
   </div>
 </div>

<!-- å³ä¸Šè§’ Admin -->
<button class="btn btn-dark floating-admin-btn" data-bs-toggle="offcanvas" data-bs-target="#admin" aria-controls="admin">âš™ï¸ Admin</button>

<!-- Offcanvas æ§åˆ¶å° -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="admin" aria-labelledby="adminLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="adminLabel">âš™ï¸ æ§åˆ¶å°</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

     <div class="offcanvas-body d-flex flex-column gap-3">
     <ul class="nav nav-tabs" role="tablist">
       <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-admin" type="button" role="tab">ç®¡ç†è¨­å®š</button></li>
       <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-winners" type="button" role="tab">ä¸­çç´€éŒ„</button></li>
     </ul>

     <div class="tab-content flex-grow-1">

       <!-- ç®¡ç†è¨­å®šï¼šåªè¨­å®šå¯¦éš›ä¸­çè€… -->
       <div class="tab-pane fade show active" id="tab-admin" role="tabpanel">
         <div class="small text-muted mb-2">é€™è£¡çš„è¨­å®š <strong>æœƒæ±ºå®šçœŸå¯¦çµæœ</strong>ã€‚è§€çœ¾ä¸æœƒçœ‹åˆ°ã€‚</div>
         
         <div class="card">
           <div class="card-header">è¨­å®šå¯¦éš›ä¸­çè€…</div>
           <div class="card-body">
             <div class="d-flex align-items-center gap-2 mb-3">
               <label class="form-label mb-0">å…§å®šä¸‹ä¸€è½‰ï¼š</label>
               <select id="rigSelect" class="form-select" style="width:220px">
                 <option value="">ï¼ˆä¸å…§å®šï¼‰</option>
               </select>
               <button id="clearRig" class="btn btn-outline-danger btn-sm">æ¸…é™¤å…§å®š</button>
             </div>
             <div class="small text-muted">
               â€¢ é¸æ“‡å…§å®šå¾Œï¼Œä¸‹æ¬¡æŠ½çå¿…å®šæ˜¯è©²äººå“¡<br>
               â€¢ å…§å®šåªç”Ÿæ•ˆä¸€æ¬¡ï¼Œç”¨å®Œè‡ªå‹•æ¸…é™¤<br>
               â€¢ ä¸è¨­å®šå…§å®šå‰‡éš¨æ©ŸæŠ½ç
             </div>
           </div>
         </div>

         <div class="card">
           <div class="card-header">å¸³è™Ÿç®¡ç†</div>
           <div class="card-body">
             <div class="table-responsive">
               <table class="table table-striped table-hover mb-0">
                 <thead class="table-light">
                   <tr><th>#</th><th>åç¨±</th><th class="text-center">å…§å®šä¸‹ä¸€è½‰</th><th class="text-center">åˆªé™¤</th></tr>
                 </thead>
                 <tbody id="adminTbody"></tbody>
               </table>
             </div>
           </div>
         </div>

         <div id="msg" class="mt-3"></div>
       </div>

       <!-- ä¸­çç´€éŒ„ -->
       <div class="tab-pane fade" id="tab-winners" role="tabpanel">
         <div class="d-flex justify-content-between align-items-center mb-2">
           <h6 class="mb-0">ä¸­çç´€éŒ„</h6>
           <div class="d-flex gap-2">
             <button id="exportBtn" class="btn btn-outline-primary btn-sm">åŒ¯å‡º CSV</button>
             <button id="clearWinBtn" class="btn btn-outline-danger btn-sm">æ¸…ç©ºç´€éŒ„</button>
           </div>
         </div>
         <div class="table-responsive">
           <table class="table table-striped table-hover align-middle">
             <thead class="table-light">
               <tr><th>#</th><th>å§“å</th><th>æ™‚é–“ï¼ˆæœ¬åœ°ï¼‰</th><th>ISO</th></tr>
             </thead>
             <tbody id="winnersBody"></tbody>
           </table>
         </div>
       </div>

     </div>
   </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(() => {
     // ========= è³‡æ–™æ¨¡å‹ =========
   // ç°¡åŒ–ç‚ºå–®ä¸€åå–®ï¼šæ¯å€‹å¸³è™Ÿæœ‰ id/name/color/tickets
   // ç®¡ç†å“¡å¯ä»¥è¨­å®šå…§å®šä¸­çè€…
   let accounts = []; // {id,name,color,tickets}
   let rigNextId = null;        // å…§å®šä¸‹ä¸€è½‰
   let spinning = false;
   let currentRotation = 0;     // deg

  // ========= DOMï¼ˆå±•ç¤ºï¼‰=========
  const wheel = document.getElementById('wheel');
  const wctx  = wheel.getContext('2d');
  const tip   = document.getElementById('tip');

     // ========= DOMï¼ˆç”¨æˆ¶ç•Œé¢ï¼‰=========
   const displayTbody = document.getElementById('displayTbody');
   const sumDisplayTicketsEl = document.getElementById('sumDisplayTickets');
   const addDisplayForm = document.getElementById('addDisplayForm');
   const dName = document.getElementById('dName');
   const dTickets = document.getElementById('dTickets');
   const dColor = document.getElementById('dColor');

   // ========= DOMï¼ˆç®¡ç†ç•Œé¢ï¼‰=========
   const adminTbody = document.getElementById('adminTbody');
   const rigSelect = document.getElementById('rigSelect');
   const msg = document.getElementById('msg');

  // ========= DOMï¼ˆç´€éŒ„ï¼‰=========
  const winnersBody = document.getElementById('winnersBody');

  // ========= å·¥å…· =========
  const uid = (()=>{ let n=1; return ()=>n++; })();
  const sum = (arr, fn) => arr.reduce((a,b)=>a+fn(b),0);
  const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
  const showToast = (html, type='light') => { msg.innerHTML = `<div class="alert alert-${type} mb-0">${html}</div>`; };

  // éš¨æ©Ÿè‰²ï¼ˆåªåœ¨ç„¡è‡ªé¸è‰²æ™‚ä½¿ç”¨ï¼‰
  const randColor = (i=0)=>`hsl(${(i*137.508)%360} 80% 60%)`;

     // ========= æ°¸çºŒåŒ– =========
   function persist(){
     localStorage.setItem('lottery_simple_accounts', JSON.stringify(accounts));
     localStorage.setItem('lottery_simple_rig', JSON.stringify(rigNextId));
   }
   function loadPersist(){
     try{
       const a = JSON.parse(localStorage.getItem('lottery_simple_accounts')||'[]');
       if (Array.isArray(a)) accounts = a;
       const r = JSON.parse(localStorage.getItem('lottery_simple_rig')||'null');
       rigNextId = r;
     }catch{}
   }

     // ========= åˆå§‹åŒ–ç¤ºä¾‹ =========
   function loadDemo(){
     accounts = [
       { id: uid(), name:'å°æ˜', color:randColor(0), tickets:5 },
       { id: uid(), name:'å°ç¾', color:randColor(1), tickets:2 },
       { id: uid(), name:'é˜¿ä¸¹', color:randColor(2), tickets:3 },
       { id: uid(), name:'æ—ºè²¡', color:randColor(3), tickets:1 },
     ];
     rigNextId = null;
     currentRotation = 0;
     updateAll();
   }

     // ========= è½‰ç›¤ç¹ªåœ– =========
   function drawWheel(){
     const list = accounts.filter(a=>(a.tickets|0) > 0);
     const W=wheel.width,H=wheel.height,cx=W/2,cy=H/2,r=Math.min(cx,cy)-8;
     wctx.clearRect(0,0,W,H);

     const totalTickets = Math.max(sum(list, a=>a.tickets|0), 0.000001);
     let start = (currentRotation % 360) * Math.PI/180;

     list.forEach(a=>{
       const frac = (a.tickets|0)/totalTickets;
       const sweep = frac * Math.PI*2;

       wctx.beginPath();
       wctx.moveTo(cx,cy);
       wctx.arc(cx,cy,r,start,start+sweep);
       wctx.closePath();
       wctx.fillStyle = a.color || '#ccc';
       wctx.fill();
       wctx.strokeStyle = '#fff'; wctx.lineWidth=2; wctx.stroke();

       const mid=start+sweep/2;
       const tx=cx+Math.cos(mid)*r*0.62, ty=cy+Math.sin(mid)*r*0.62;
       wctx.save();
       wctx.translate(tx,ty); wctx.rotate(mid);
       wctx.textAlign='center'; wctx.textBaseline='middle';
       wctx.fillStyle='#222';
       wctx.font='bold 16px system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Arial';
       wrapText(wctx, a.name, 0,0, r*0.52, 18);
       wctx.restore();

       start += sweep;
     });

     // ä¸­å¿ƒåœ“
     wctx.beginPath(); wctx.arc(cx,cy,r*0.1,0,Math.PI*2);
     wctx.fillStyle='#fff'; wctx.fill();
     wctx.strokeStyle='#ddd'; wctx.stroke();
   }
  function wrapText(ctx, text, x,y, maxW, lh){
    const chars = (text||'').split(''); let line='', yoff=0;
    for(let i=0;i<chars.length;i++){
      const test=line+chars[i];
      if(ctx.measureText(test).width>maxW && i>0){ ctx.fillText(line,x,y+yoff); line=chars[i]; yoff+=lh; }
      else line=test;
    }
    ctx.fillText(line,x,y+yoff);
  }

     // ========= ç”¨æˆ¶ç•Œé¢è¡¨æ ¼ =========
   function renderDisplayTable(){
     const list = accounts.filter(a=>(a.tickets|0)>0);
     displayTbody.innerHTML='';
     list.forEach((a,idx)=>{
       const tr = document.createElement('tr');
       tr.innerHTML = `
         <td>${idx+1}</td>
         <td><input class="form-control form-control-sm" value="${a.name}"></td>
         <td class="text-center"><input class="form-control form-control-sm qty" type="number" min="0" step="1" value="${a.tickets|0}"></td>
         <td class="text-center">
           <div class="btn-group btn-group-sm">
             <button class="btn btn-outline-secondary minus">âˆ’1</button>
             <button class="btn btn-outline-secondary plus">+1</button>
           </div>
         </td>
         <td class="text-center">
           <button class="btn btn-sm btn-outline-danger del">åˆªé™¤</button>
         </td>
       `;
       // åç¨±
       tr.children[1].querySelector('input').addEventListener('input', ev=>{
         a.name = ev.target.value; rebuildRigSelect(); renderAdminTable(); drawWheel(); persist();
       });
       // ç±¤æ•¸
       const qty = tr.children[2].querySelector('.qty');
       qty.addEventListener('input', ev=>{
         a.tickets = Math.max(0, Math.floor(+ev.target.value||0));
         updateDisplaySum(); drawWheel(); persist();
       });
       tr.querySelector('.minus').addEventListener('click', ()=>{
         a.tickets = Math.max(0, (a.tickets|0) - 1); qty.value=a.tickets; updateDisplaySum(); drawWheel(); persist();
       });
       tr.querySelector('.plus').addEventListener('click', ()=>{
         a.tickets = (a.tickets|0) + 1; qty.value=a.tickets; updateDisplaySum(); drawWheel(); persist();
       });
       // åˆªé™¤
       tr.querySelector('.del').addEventListener('click', ()=>{
         if (rigNextId === a.id) rigNextId = null;
         if (rigSelect.value == a.id) rigSelect.value = '';
         accounts = accounts.filter(x => x.id !== a.id);
         updateAll();
       });
       displayTbody.appendChild(tr);
     });
   }
   function updateDisplaySum(){
     const list = accounts.filter(a=>(a.tickets|0)>0);
     sumDisplayTicketsEl.textContent = sum(list, a=>a.tickets|0);
   }

     // ========= ç®¡ç†è¡¨æ ¼ =========
   function renderAdminTable(){
     const list = accounts.slice();
     adminTbody.innerHTML='';
     list.forEach((a,idx)=>{
       const tr = document.createElement('tr');
       tr.innerHTML = `
         <td>${idx+1}</td>
         <td><input class="form-control form-control-sm" value="${a.name}"></td>
         <td class="text-center">
           <div class="form-check d-flex justify-content-center">
             <input class="form-check-input rigbox" type="checkbox" ${(rigNextId===a.id || rigSelect.value==a.id)?'checked':''}>
           </div>
         </td>
         <td class="text-center"><button class="btn btn-sm btn-outline-danger del">åˆªé™¤</button></td>
       `;
       // åç¨±åŒæ­¥
       tr.children[1].querySelector('input').addEventListener('input', ev=>{
         a.name = ev.target.value; rebuildRigSelect(); renderDisplayTable(); drawWheel(); persist();
       });
       // å…§å®šï¼ˆæ¯åˆ—ï¼‰
       tr.children[2].querySelector('.rigbox').addEventListener('change', ev=>{
         if(ev.target.checked){ 
           rigNextId = a.id; 
           rigSelect.value = a.id;
         } else if(rigNextId===a.id || rigSelect.value==a.id){ 
           rigNextId = null; 
           rigSelect.value = '';
         }
         persist(); renderAdminTable(); rebuildRigSelect();
       });
       // åˆªé™¤
       tr.children[3].querySelector('.del').addEventListener('click', ()=>{
         if (rigNextId === a.id) rigNextId = null;
         if (rigSelect.value == a.id) rigSelect.value = '';
         accounts = accounts.filter(x => x.id !== a.id);
         updateAll();
       });
       adminTbody.appendChild(tr);
     });
   }
  function rebuildRigSelect(){
    const prev = rigSelect.value || '';
    rigSelect.innerHTML = `<option value="">ï¼ˆä¸å…§å®šï¼‰</option>` + accounts.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
    rigSelect.value = prev;
    
    // åŒæ­¥æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    updateStatusDisplay();
  }

     // ========= Winners =========
   function getWinners(){ try{ return JSON.parse(localStorage.getItem('lottery_simple_winners')||'[]'); }catch{ return []; } }
   function setWinners(list){ localStorage.setItem('lottery_simple_winners', JSON.stringify(list)); }
  function addWinner(name){
    const list = getWinners();
    list.push({ name, time: new Date().toISOString() });
    setWinners(list);
    renderWinners();
  }
  function renderWinners(){
    const list=getWinners();
    winnersBody.innerHTML='';
    list.forEach((r,i)=>{
      const dt=new Date(r.time);
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${r.name}</td><td>${dt.toLocaleString()}</td><td>${r.time}</td>`;
      winnersBody.appendChild(tr);
    });
  }

     // ========= æŠ½çé‚è¼¯ =========
   function pickWinner(){
     // 1) å…§å®šï¼ˆåƒ…ä¸‹ä¸€è½‰ï¼‰
     if (rigSelect.value) {
       const id = Number(rigSelect.value);
       const a = accounts.find(x=>x.id===id);
       rigNextId = null; // ç”¨ä¸‹æ‹‰é¸å–®è¦–ç‚ºä¸€æ¬¡æ€§
       rigSelect.value = '';
       persist(); rebuildRigSelect(); renderAdminTable();
       return a || null;
     }
     if (rigNextId != null) {
       const a = accounts.find(x=>x.id===rigNextId) || null;
       rigNextId = null; persist(); rebuildRigSelect(); renderAdminTable();
       return a;
     }
     // 2) éš¨æ©ŸæŠ½çï¼ˆä¾ç±¤æ•¸ï¼‰
     const list = accounts.filter(a=>(a.tickets|0)>0);
     if (list.length === 0) return null;
     
     const total = sum(list, a=>a.tickets|0);
     if (total <= 0) return null;
     
     let r = Math.random()*total;
     for (const a of list) {
       r -= (a.tickets|0);
       if (r <= 1e-12) return a;
     }
     return list[list.length-1] || null;
   }

     // è¨ˆç®—è®“ã€Œä¸­çè€…ã€åœ¨è½‰ç›¤åœåœ¨æŒ‡é‡ 12 é»æ–¹å‘
   function targetAngleForWinner(winnerId){
     const winner = accounts.find(a=>a.id===winnerId);
     if (!winner) return currentRotation + (360*18) + Math.random()*360;

     // ç²å–æ‰€æœ‰æœ‰ç±¤æ•¸çš„å¸³è™Ÿ
     const list = accounts.filter(a=>(a.tickets|0)>0);
     
     // å¦‚æœä¸­çè€…ä¸åœ¨é¡¯ç¤ºåˆ—è¡¨ä¸­ï¼Œå‰µå»ºä¸€å€‹è‡¨æ™‚åˆ—è¡¨åŒ…å«ä»–
     let tempList = list.slice();
     if (!tempList.find(x=>x.id===winnerId)) {
       // çµ¦äºˆä¸€å€‹æ¥µå°çš„ç±¤æ•¸ï¼Œç¢ºä¿ä»–èƒ½è¢«æŒ‡å‘
       tempList.push({ 
         id: winner.id, 
         name: winner.name, 
         color: winner.color || '#ccc', 
         tickets: 0.00001 
       });
     }

     // è¨ˆç®—ç¸½ç±¤æ•¸
     const total = tempList.reduce((s,a)=> s + ((a.tickets||0)*1), 0);
     if (total <= 0) return currentRotation + (360*18) + Math.random()*360;

     // è¨ˆç®—æ¯å€‹åˆ‡ç‰‡çš„è§’åº¦
     let startDeg = (currentRotation % 360 + 360) % 360;
     let acc = 0;

     for (const a of tempList) {
       const sweep = ((a.tickets||0)/total) * 360;
       const segStart = startDeg + acc;
       const mid = segStart + sweep/2;
       
       if (a.id === winnerId) {
         // è¨ˆç®—è®“ä¸­çè€…åœåœ¨12é»æ–¹å‘çš„è§’åº¦
         // 12é»æ–¹å‘æ˜¯ -90åº¦ï¼ˆæˆ–270åº¦ï¼‰
         const targetAngle = -90;
         const currentMid = mid * Math.PI / 180;
         const targetRad = targetAngle * Math.PI / 180;
         
         // è¨ˆç®—éœ€è¦æ—‹è½‰çš„è§’åº¦
         const angleDiff = targetRad - currentMid;
         const rotations = 18; // å¤šè½‰å¹¾åœˆ
         const finalAngle = currentRotation + (rotations * 360) + (angleDiff * 180 / Math.PI);
         
         return finalAngle;
       }
       acc += sweep;
     }
     
     return currentRotation + (360*18) + Math.random()*360;
   }

  function animateTo(endDeg, duration=4000){
    const start=currentRotation, delta=endDeg-start;
    const t0=performance.now(); const ease=t=>1-Math.pow(1-t,3);
    const step = now=>{
      const p=clamp((now-t0)/duration,0,1);
      currentRotation = start + delta*ease(p);
      drawWheel();
      if(p<1) requestAnimationFrame(step);
      else currentRotation=endDeg%360;
    };
    requestAnimationFrame(step);
  }

     // ========= æ›´æ–° =========
   function updateAll(){
     renderDisplayTable();
     renderAdminTable();
     rebuildRigSelect();
     updateDisplaySum();
     drawWheel();
     persist();
     
     // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
     updateStatusDisplay();
   }
  
  function updateStatusDisplay(){
    if(rigNextId) {
      const riggedPerson = accounts.find(a => a.id === rigNextId);
      if(riggedPerson) {
        // tip.textContent = `ğŸ¯ å·²è¨­å®šå…§å®šä¸‹ä¸€è½‰ï¼š${riggedPerson.name}ï¼Œç­‰å¾…æŠ½çâ€¦`;
      } else {
        tip.textContent = 'è¨­å®šå·²æ›´æ–°ï¼Œç­‰å¾…æŠ½çâ€¦';
      }
    } else if(rigSelect.value) {
      const riggedPerson = accounts.find(a => a.id === Number(rigSelect.value));
      if(riggedPerson) {
        tip.textContent = `ğŸ¯ å·²è¨­å®šå…§å®šä¸‹ä¸€è½‰ï¼š${riggedPerson.name}ï¼Œç­‰å¾…æŠ½çâ€¦`;
      } else {
        tip.textContent = 'è¨­å®šå·²æ›´æ–°ï¼Œç­‰å¾…æŠ½çâ€¦';
      }
    } else {
      tip.textContent = 'è¨­å®šå·²æ›´æ–°ï¼Œç­‰å¾…æŠ½çâ€¦';
    }
  }

     // ========= äº‹ä»¶ç¹«çµ =========
   // ç”¨æˆ¶ç•Œé¢ï¼šæ–°å¢
   addDisplayForm.addEventListener('submit', ev=>{
     ev.preventDefault();
     const name = dName.value.trim();
     const tickets = Math.max(0, Math.floor(+dTickets.value||0));
     if (!name) return;
     
     // åŒåè‹¥å·²å­˜åœ¨å°±æ›´æ–°ï¼Œå¦å‰‡å»ºæ–°å¸³è™Ÿ
     let a = accounts.find(x=>x.name===name);
     if (!a) {
       a = { id: uid(), name, color: dColor.value || randColor(accounts.length), tickets };
       accounts.push(a);
     } else {
       a.tickets = tickets;
       if (!a.color) a.color = dColor.value || randColor(accounts.length);
     }
     dName.value=''; dTickets.value='1';
     updateAll();
   });

   document.getElementById('normalizeDisplay').addEventListener('click', ()=>{
     const list = accounts.filter(a=>(a.tickets|0)>0);
     const s = list.reduce((t,a)=>t+(a.tickets|0),0);
     if (s<=0) return;
     list.forEach(a=> a.tickets = Math.max(0, Math.round(((a.tickets|0)/s)*100)) );
     updateAll();
   });
   document.getElementById('loadDemoDisplay').addEventListener('click', ()=>{ loadDemo(); });

  document.getElementById('clearRig').addEventListener('click', ()=>{
    rigNextId=null; rigSelect.value=''; persist();
    updateStatusDisplay();
    showToast('å·²æ¸…é™¤å…§å®šã€‚','light');
  });

  rigSelect.addEventListener('change', ()=>{
    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    updateStatusDisplay();
  });

     // æŠ½çæŒ‰éˆ•
   document.getElementById('spinBtn').addEventListener('click', ()=>{
     if (spinning) return;
     if (!accounts.length){ showToast('å°šç„¡å¸³è™Ÿã€‚','warning'); return; }

     // æ£€æŸ¥æ˜¯å¦ä¸ºå†…å®šæŠ½å¥–
     const wasRigged = rigNextId || rigSelect.value;
     
     const winner = pickWinner();
     if (!winner){ showToast('ç±¤æ•¸ç¸½å’Œç‚º 0ï¼Œç„¡æ³•æŠ½çã€‚','danger'); return; }

     const target = targetAngleForWinner(winner.id);
     spinning = true;
     
     // æ˜¾ç¤ºæŠ½å¥–ä¿¡æ¯ï¼Œå¦‚æœæ˜¯å†…å®šåˆ™ç‰¹åˆ«æ ‡æ³¨
     if(wasRigged) {
    //    tip.textContent = `ğŸ¯ å…§å®šæŠ½å‡ºã€Œ${winner.name}ã€â€¦`;
     } else {
       tip.textContent = `æ­£åœ¨æŠ½å‡ºã€Œ${winner.name}ã€â€¦`;
     }
     
     animateTo(target, 4000);
     setTimeout(()=>{
       spinning=false;
    //    tip.textContent = `ä¸­çè€…ï¼š${winner.name}`;
       addWinner(winner.name);
       
       // æ˜¾ç¤ºç»“æœï¼Œå¦‚æœæ˜¯å†…å®šåˆ™ç‰¹åˆ«æ ‡æ³¨
       if(wasRigged) {
        //  showToast(`ğŸ¯ å…§å®šä¸­çè€…ï¼š<strong>${winner.name}</strong>ï¼ˆå·²è¨˜éŒ„ï¼‰`, 'success');
       } else {
        //  showToast(`ä¸­çè€…ï¼š<strong>${winner.name}</strong>ï¼ˆå·²è¨˜éŒ„ï¼‰`, 'success');
       }
     }, 4100);
   });

  // ç´€éŒ„é¢æ¿
  document.getElementById('clearWinBtn').addEventListener('click', ()=>{
    if (confirm('ç¢ºå®šæ¸…ç©ºæ‰€æœ‰ä¸­çç´€éŒ„ï¼Ÿ')){ setWinners([]); renderWinners(); }
  });
  document.getElementById('exportBtn').addEventListener('click', ()=>{
    const rows = [['#','name','local_time','iso_time']];
    const list = getWinners();
    list.forEach((r,i)=>{
      const dt=new Date(r.time);
      rows.push([i+1, r.name, dt.toLocaleString(), r.time]);
    });
    const csv = rows.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='winners.csv'; a.click(); URL.revokeObjectURL(url);
  });

  // ========= å•Ÿå‹• =========
  loadPersist();
  if (!accounts.length) loadDemo(); else updateAll();
  renderWinners();

})();
</script>
</body>
</html>
